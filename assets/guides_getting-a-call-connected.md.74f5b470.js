import{_ as s,c as n,o as a,a as e}from"./app.d5757ab6.js";const d=JSON.parse(`{"title":"Getting a Call Connected","description":"","frontmatter":{},"headers":[{"level":2,"title":"Step 1 - Prepare to call, grab media stream","slug":"step-1-prepare-to-call-grab-media-stream"},{"level":2,"title":"Step 2 - Create your peer, add the media stream","slug":"step-2-create-your-peer-add-the-media-stream"},{"level":2,"title":"Step 3 - Signal that you're starting a call","slug":"step-3-signal-that-you-re-starting-a-call"},{"level":2,"title":"Step 4 - Create an offer, set the local description","slug":"step-4-create-an-offer-set-the-local-description"},{"level":2,"title":"Step 5 - Handling the ICE Candidates on both sides","slug":"step-5-handling-the-ice-candidates-on-both-sides"},{"level":2,"title":"Step 6 - Set the remote description, create an answer, set the local description","slug":"step-6-set-the-remote-description-create-an-answer-set-the-local-description"},{"level":2,"title":"Step 7 - Set the remote description","slug":"step-7-set-the-remote-description"},{"level":2,"title":"Step 8 - You should now be connected","slug":"step-8-you-should-now-be-connected"}],"relativePath":"guides/getting-a-call-connected.md"}`),l={name:"guides/getting-a-call-connected.md"},o=e(`<h1 id="getting-a-call-connected" tabindex="-1">Getting a Call Connected <a class="header-anchor" href="#getting-a-call-connected" aria-hidden="true">#</a></h1><p>Before continuing please make sure you have followed the platform install guides and have a working signalling server which can relay data to and from call participants.</p><p>Generally speaking using Web Sockets is recommended due to low latency, speed and bandwidth usage but be prepared to consider fallback mechanisms like a REST API which usually polls for messages within a set duration.</p><p>You should also consider that network conditions won&#39;t always be great and can mostly be restrictive. Real-time Web Sockets might not function entirely or correctly in some circumstances.</p><p>This guide covers the general basic steps of how you can get a call connected between 2 clients and assumes that you have read our <a href="/guides/basic-usage">basic usage doc</a> which lists most of the supported functions by this module.</p><p>You should also check <a href="/guides/improving-call-reliability">this guide</a> as it covers why you should be using a STUN+TURN server to improve call reliability.</p><h2 id="step-1-prepare-to-call-grab-media-stream" tabindex="-1">Step 1 - Prepare to call, grab media stream <a class="header-anchor" href="#step-1-prepare-to-call-grab-media-stream" aria-hidden="true">#</a></h2><p>This will give us a media stream for the front facing camera and input from a microphone.<br> As you can see if we flip the <code>isVoiceOnly</code> boolean over to <code>true</code> then we&#39;d be disabling the video track.</p><p>If you want to start the call as voice only then you can flip the boolean but the catch is that you can enable the video track while the call is in progress, no messing around creating and adding another media stream or starting a new call.</p><p><strong>Don&#39;t forget, you will be prompted to accept permissions for the camera and microphone.</strong><br><strong>Usually it is better to request permissions at an earlier stage to improve the user experience.</strong></p><div class="language-javascript"><button class="copy"></button><span class="lang">javascript</span><pre><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> mediaConstraints </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F07178;">audio</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F07178;">video</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#F07178;">frameRate</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">30</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#F07178;">facingMode</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">user</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> localMediaStream</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> isVoiceOnly </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mediaStream</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mediaDevices</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getUserMedia</span><span style="color:#F07178;">( </span><span style="color:#A6ACCD;">mediaConstraints</span><span style="color:#F07178;"> )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> ( </span><span style="color:#A6ACCD;">isVoiceOnly</span><span style="color:#F07178;"> ) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">videoTrack</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mediaStream</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getVideoTracks</span><span style="color:#F07178;">()[ </span><span style="color:#F78C6C;">0</span><span style="color:#F07178;"> ]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#A6ACCD;">videoTrack</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">enabled</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">localMediaStream</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mediaStream</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;">( err ) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// Handle Error</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre></div><h2 id="step-2-create-your-peer-add-the-media-stream" tabindex="-1">Step 2 - Create your peer, add the media stream <a class="header-anchor" href="#step-2-create-your-peer-add-the-media-stream" aria-hidden="true">#</a></h2><p>Now that we&#39;ve got the media stream which consists of an audio and video track we can actually start getting the peer connection created and ready to connect. Once the media stream has been added to the peer then the <code>negotiationneeded</code> event will fire to indicate that you can now start creating an offer.</p><p>In some instances you might find that the <code>negotiationneeded</code> event can fire multiple times at random and as such if you decide to run the <code>createOffer</code> function within that event then you need to ensure that you don&#39;t allow running <code>createOffer</code> multiple times, otherwise the peer will most likely get stuck in a weird state.</p><p>The <code>iceServers</code> below include one of Googles public STUN servers, you should also provide your own TURN server alongside a STUN server to ensure that connections can actually be established between callers.</p><div class="language-javascript"><button class="copy"></button><span class="lang">javascript</span><pre><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> peerConstraints </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F07178;">iceServers</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> [</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">			</span><span style="color:#F07178;">urls</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">stun:stun.l.google.com:19302</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">	]</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> peerConnection </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">RTCPeerConnection</span><span style="color:#A6ACCD;">( peerConstraints )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">peerConnection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">addEventListener</span><span style="color:#A6ACCD;">( </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">connectionstatechange</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">event</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">switch</span><span style="color:#F07178;">( </span><span style="color:#A6ACCD;">peerConnection</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">connectionState</span><span style="color:#F07178;"> ) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">case</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">closed</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">			</span><span style="color:#676E95;">// You can handle the call being disconnected here.</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">peerConnection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">addEventListener</span><span style="color:#A6ACCD;">( </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">icecandidate</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">event</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// When you find a null candidate then there are no more candidates.</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// Gathering of candidates has finished.</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> ( </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">candidate</span><span style="color:#F07178;"> ) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">return</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// Send the event.candidate onto the person you&#39;re calling.</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// Keeping to Trickle ICE Standards, you should send the candidates immediately.</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">peerConnection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">addEventListener</span><span style="color:#A6ACCD;">( </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">icecandidateerror</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">event</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// You can ignore some candidate errors.</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// Connections can still be made even when errors occur.</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">peerConnection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">addEventListener</span><span style="color:#A6ACCD;">( </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">iceconnectionstatechange</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">event</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">switch</span><span style="color:#F07178;">( </span><span style="color:#A6ACCD;">peerConnection</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">iceConnectionState</span><span style="color:#F07178;"> ) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">case</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">connected</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">case</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">completed</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">			</span><span style="color:#676E95;">// You can handle the call being connected here.</span></span>
<span class="line"><span style="color:#89DDFF;">			</span><span style="color:#676E95;">// Like setting the video streams to visible.</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">peerConnection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">addEventListener</span><span style="color:#A6ACCD;">( </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">negotiationneeded</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">event</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// You can start the offer stages here.</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// Be careful as this event can be called multiple times.</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">peerConnection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">addEventListener</span><span style="color:#A6ACCD;">( </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">signalingstatechange</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">event</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">switch</span><span style="color:#F07178;">( </span><span style="color:#A6ACCD;">peerConnection</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">signalingState</span><span style="color:#F07178;"> ) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">case</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">closed</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">			</span><span style="color:#676E95;">// You can handle the call being disconnected here.</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">peerConnection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">addEventListener</span><span style="color:#A6ACCD;">( </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">addstream</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">event</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// Grab the remote stream from the connected participant.</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">remoteMediaStream</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">stream</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#676E95;">// Add our stream to the peer connection.</span></span>
<span class="line"><span style="color:#A6ACCD;">peerConnection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">addStream</span><span style="color:#A6ACCD;">( localMediaStream )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><h2 id="step-3-signal-that-you-re-starting-a-call" tabindex="-1">Step 3 - Signal that you&#39;re starting a call <a class="header-anchor" href="#step-3-signal-that-you-re-starting-a-call" aria-hidden="true">#</a></h2><p>Now would be a good time to officially announce the incoming call to other call participant.<br> Using your signalling server you will need to trigger a call start event.</p><p>Whether you trigger the event via Notifications or Web Sockets, the purpose of the event is to ensure that the call participant runs the code above ^ they will then be prepared to start the handshake process.</p><p>We can&#39;t give any sample code for the signalling stages.<br> But do intend to provide an example app along with signalling app in the near future.</p><h2 id="step-4-create-an-offer-set-the-local-description" tabindex="-1">Step 4 - Create an offer, set the local description <a class="header-anchor" href="#step-4-create-an-offer-set-the-local-description" aria-hidden="true">#</a></h2><p>We&#39;ve added the media stream to the peer connection and got most of the basic events hooked up. You can now start creating an offer which then needs sending off to the other call participant.</p><div class="language-javascript"><button class="copy"></button><span class="lang">javascript</span><pre><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> sessionConstraints </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F07178;">mandatory</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#F07178;">OfferToReceiveAudio</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#F07178;">OfferToReceiveVideo</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#F07178;">VoiceActivityDetection</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">offerDescription</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">peerConnection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createOffer</span><span style="color:#F07178;">( </span><span style="color:#A6ACCD;">sessionConstraints</span><span style="color:#F07178;"> )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">peerConnection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setLocalDescription</span><span style="color:#F07178;">( </span><span style="color:#A6ACCD;">offerDescription</span><span style="color:#F07178;"> )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// Send the offerDescription to the other participant.</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;">( err ) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// Handle Errors</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre></div><h2 id="step-5-handling-the-ice-candidates-on-both-sides" tabindex="-1">Step 5 - Handling the ICE Candidates on both sides <a class="header-anchor" href="#step-5-handling-the-ice-candidates-on-both-sides" aria-hidden="true">#</a></h2><p>As specified in the <code>icecandidate</code> event above, you should send candidates as soon as they are generated.</p><p>You can trigger the following <code>handleRemoteCandidate</code> function to handle the received candidates on both sides.</p><p>In some circumstances candidates can&#39;t be immediately processed. An easy solution is to hold onto some of the candidates and process them immediately after.</p><p>We will process any leftover candidates in the next step.</p><div class="language-javascript"><button class="copy"></button><span class="lang">javascript</span><pre><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> remoteCandidates </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> []</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">handleRemoteCandidate</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">iceCandidate</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">iceCandidate</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">RTCIceCandidate</span><span style="color:#F07178;">( </span><span style="color:#A6ACCD;">iceCandidate</span><span style="color:#F07178;"> )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> ( </span><span style="color:#A6ACCD;">peerConnection</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">remoteDescription</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;"> ) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">remoteCandidates</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">push</span><span style="color:#F07178;">( </span><span style="color:#A6ACCD;">iceCandidate</span><span style="color:#F07178;"> )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">peerConnection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">addIceCandidate</span><span style="color:#F07178;">( </span><span style="color:#A6ACCD;">iceCandidate</span><span style="color:#F07178;"> )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">processCandidates</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> ( </span><span style="color:#A6ACCD;">remoteCandidates</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> ) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">return</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">remoteCandidates</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">map</span><span style="color:#F07178;">( </span><span style="color:#A6ACCD;">candidate</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">peerConnection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">addIceCandidate</span><span style="color:#F07178;">( </span><span style="color:#A6ACCD;">candidate</span><span style="color:#F07178;"> ) )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">remoteCandidates</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> []</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre></div><h2 id="step-6-set-the-remote-description-create-an-answer-set-the-local-description" tabindex="-1">Step 6 - Set the remote description, create an answer, set the local description <a class="header-anchor" href="#step-6-set-the-remote-description-create-an-answer-set-the-local-description" aria-hidden="true">#</a></h2><p>Now that you&#39;ve received an offer we can create the compatible answer.<br> Set the offer as the remote description, create an answer and set the local description as your answer.</p><p>You can now process any candidates if any got caught in-between the handshake process.<br> Lastly you need to send the answer back to the caller who gave the offer.</p><div class="language-javascript"><button class="copy"></button><span class="lang">javascript</span><pre><code><span class="line"><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// Use the received offerDescription</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">offerDescription</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">RTCSessionDescription</span><span style="color:#F07178;">( </span><span style="color:#A6ACCD;">offerDescription</span><span style="color:#F07178;"> )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">peerConnection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setRemoteDescription</span><span style="color:#F07178;">( </span><span style="color:#A6ACCD;">offerDescription</span><span style="color:#F07178;"> )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">answerDescription</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">peerConnection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createAnswer</span><span style="color:#F07178;">( </span><span style="color:#A6ACCD;">sessionConstraints</span><span style="color:#F07178;"> )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">peerConnection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setLocalDescription</span><span style="color:#F07178;">( </span><span style="color:#A6ACCD;">answerDescription</span><span style="color:#F07178;"> )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// Here is a good place to process candidates.</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">processCandidates</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// Send the answerDescription back as a response to the offerDescription.</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;">( err ) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// Handle Errors</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre></div><h2 id="step-7-set-the-remote-description" tabindex="-1">Step 7 - Set the remote description <a class="header-anchor" href="#step-7-set-the-remote-description" aria-hidden="true">#</a></h2><p>To finalise the handshake mechanism the call initialiser sets the received answer as their remote description.</p><p>Then the waiting game begins and the connection is a success or a failure.<br> Hopefully the whole process wasn&#39;t too complex to understand.<br> But it definitely can get more complex when involving more participants.</p><div class="language-javascript"><button class="copy"></button><span class="lang">javascript</span><pre><code><span class="line"><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// Use the received answerDescription</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">answerDescription</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">RTCSessionDescription</span><span style="color:#F07178;">( </span><span style="color:#A6ACCD;">answerDescription</span><span style="color:#F07178;"> )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">peerConnection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setRemoteDescription</span><span style="color:#F07178;">( </span><span style="color:#A6ACCD;">answerDescription</span><span style="color:#F07178;"> )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;">( err ) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// Handle Error</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre></div><h2 id="step-8-you-should-now-be-connected" tabindex="-1">Step 8 - You should now be connected <a class="header-anchor" href="#step-8-you-should-now-be-connected" aria-hidden="true">#</a></h2><p>Hopefully everything went as expected and the call is now connected.<br> If the <code>iceconnectionstatechange</code> event triggered on <code>connected</code> and/or <code>completed</code> then you&#39;re good to go.</p><p>You might want to bare in mind that some of the events can be triggered multiple times.</p><p>If you&#39;re having issues after following this guide then feel free to create a post on our <a href="https://react-native-webrtc.discourse.group/" target="_blank" rel="noreferrer">Discourse</a> asking for help and advice.</p>`,41),p=[o];function t(c,r,i,y,F,D){return a(),n("div",null,p)}const A=s(l,[["render",t]]);export{d as __pageData,A as default};
